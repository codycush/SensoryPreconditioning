<! doctype html>
<html>
  <head>
  <style>
  img {
    width: 300px;
  }
  body{
    background-color: rgb(255,255,255);
  }
  </style>
  <title> Main Wrapper</title>
  <script src = "jspsych-6.0.1/jspsych.js"></script>

  <script src = "jspsych-6.0.1/plugins/jspsych-html-keyboard-response.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-fullscreen.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-fixation.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-call-function.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-association.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-survey-text.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-instructions.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-RDK.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-reward.js"></script>
  <script src = "jspsych-6.0.1/plugins/jspsych-decision.js"></script>

  <script src = "jspsych-6.0.1/pest.js"></script>
  <link href = "jspsych-6.0.1/css/jspsych.css" rel = "stylesheet"></link>
  </head>
  <body>
    <div id="canvasesdiv" style="position:absolute;">
      <canvas id="layer1" style="z-index: 1;position:absolute;margin:auto;display:block;left:0px;top:0px;">
      </canvas>
      <canvas id="layer2" style="z-index: 2;position:absolute;margin:auto;left:0px;top:0px;">
      </canvas>
    </div>
  </body>
  <script>

    /*var canvas=document.getElementById("layer1");
  	var layer2=document.getElementById("layer2");
    var ctx=layer1.getContext("2d");
		var ctx2=layer2.getContext("2d");*/
    var a_list=[];
    var b_list=[];
    var c_list=[];
    var d_list=[];
    var cat_names=['butterflies','horses','guitars','chairs']
    var stim_cats=[8,15,37,40] //unused cats ,19,26,28,33,35,36
    var first_num=[1,2,3,4,5,6]
    var second_num=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]
      for (var b=0;b<first_num.length;b++){
        for (var c=0;c<second_num.length;c++){
          a_list.push(stim_cats[0]+'_'+first_num[b]+'_'+second_num[c]) //butteflies
          b_list.push(stim_cats[1]+'_'+first_num[b]+'_'+second_num[c]) //horses
          c_list.push(stim_cats[2]+'_'+first_num[b]+'_'+second_num[c])//guitars
          d_list.push(stim_cats[3]+'_'+first_num[b]+'_'+second_num[c])//chairs

        }
      }

    console.log(a_list,b_list,c_list,d_list)
    var assoc_list_a=shuffle(a_list);
    var assoc_list_b=shuffle(b_list);
    var assoc_list_c=shuffle(c_list);
    var assoc_list_d=shuffle(d_list);

    var reward_list_a=shuffle(a_list);
    var reward_list_b=shuffle(b_list);
    var reward_list_c=shuffle(c_list);
    var reward_list_d=shuffle(d_list);

		//console.log(ctx2)
var dist; //global variable for participants' self-reported distance from monitor
var cmPer200Px; //self-reported measured cm for 200 px black bar image
var deg_per_px; //global for calculated px per degree
      var vd_calib={
        type: 'survey-text',
        preamble:"<p>We need to calibrate the experiment to your computer monitor.  Please answer the following questions by inputting a number into each box.</P>"+
        "<P>Press continue when finished (Note: Pressing continue will not advance the experiment until numbers are entered below):</p>"+
            "<p><font color='red'>Please use a ruler or other measuring instrument if available.  Otherwise please make your best estimate (Note that 1 inch = ~2.5 cm). </font></p>",
        questions:[
          {prompt: 'How many centimeters (cm) is your face from your computer monitor?', value: 'cm', rows:1, columns:3},
          {prompt: "<p>How many centimeters (cm) does this black bar measure on your screen?</p>"+
                    "<div style='float: center;'><img src='jspsych-6.0.1/stimuli/200px_blackbar.png'></img>", value: 'cm', rows:1,columns:3},

        ],
        on_finish: function(){
          var str=jsPsych.data.get().select('responses').values[jsPsych.data.get().select('responses').values.length-1]
          dist=parseFloat(str.slice(str.indexOf('Q0')+5,str.indexOf('Q1')-3))//pulls first response from response string
          cmPer200Px=parseFloat(str.slice(str.indexOf('Q1')+5))//pulls second response from response string
          deg_per_px = (Math.atan2(.5*cmPer200Px, dist) / (.5*200))*180/Math.PI;
          console.log(20/deg_per_px)

        },


      }
      var vd_calib_ifApertureTooBig={
        type: 'survey-text',
        preamble:"<p><font color=red>The experiment will not fit on your screen at your current viewing distance.</P>"+
        "<p>Please move closer to your computer screen and reinput your viewing distance. A reasonable viewing distance is around 60cm. </font>"+
        "<P>Press continue when finished (Note: Pressing continue will not advance the experiment until numbers are entered below):</p>"+
            "<p><font color='red'>Please use a ruler or other measuring instrument if available.  Otherwise please make your best estimate (Note that 1 inch = ~2.5 cm). </font></p>",
        questions:[
          {prompt: 'How many centimeters (cm) is your face from your computer monitor?', value: 'cm', rows:1, columns:3},
          {prompt: "<p>How many centimeters (cm) does this black bar measure on your screen?</p>"+
                    "<div style='float: center;'><img src='jspsych-6.0.1/stimuli/200px_blackbar.png'></img>", value: 'cm', rows:1,columns:3},

        ],
        on_finish: function(){
          var str=jsPsych.data.get().select('responses').values[jsPsych.data.get().select('responses').values.length-1]
          dist=parseFloat(str.slice(str.indexOf('Q0')+5,str.indexOf('Q1')-3))//pulls first response from response string
          cmPer200Px=parseFloat(str.slice(str.indexOf('Q1')+5))//pulls second response from response string
          deg_per_px = (Math.atan2(.5*cmPer200Px, dist) / (.5*200))*180/Math.PI;
          console.log(deg_per_px)

        },


      }

      var size_chill=false;
      var calib_if_node={
        timeline:[vd_calib_ifApertureTooBig],
        conditional_function:function(){
          var currAptHeight=Math.round(20/deg_per_px);
          var currViewHole=window.outerHeight;
          if (currAptHeight>currViewHole){
            size_chill=false;
            return true
          }else{
            size_chill=true;
            return false
          }
        }
      }
      var calib_loop_if={
      timeline:[calib_if_node],
      loop_function:function(){
        if(size_chill==false){
          return true
        }else{
          return false

        }
        }
      }
      var calib_loop_timeline={
        timeline:[vd_calib,calib_loop_if],
        loop_function: function(){

          if (isNaN(deg_per_px)){
            return true
          }else{
            return false
          }
        },
      }

      var fixation_block={
        type:'fixation',
        fixation_cross_color:"red",
        trial_duration:1000,
        background_color: 'rgb(255,255,255)',
      }
      var trialCounter=0;
      var randPos=[0,1,2,3];
      var imageset={
        image1: 'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_a[trialCounter] +'.png',
        image2:'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_b[trialCounter] +'.png',
        image3:'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_c[trialCounter] +'.png',
        image4:'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_d[trialCounter] +'.png',

      }
      var main_trial={
        type:'association',
        trial_duration:4500,
        response_ends_trial:false,
        coherent_direction:jsPsych.timelineVariable('coherent_direction'),
        coherence:1.0,
        move_distance:3,
        aperture_width:600,
        aperture_height:600,

        aperture_type:4,
        fixation_cross:true,
        border:true,
        choices: [37,38,39,40],
        on_finish: function(){
          trialCounter=trialCounter+1;
          var pos=[0,1,2,3];
          randPos=shuffle(pos);
          var stim_sel=[assoc_list_a[trialCounter],assoc_list_b[trialCounter],assoc_list_c[trialCounter],assoc_list_d[trialCounter]]
          imageset.image1='jsPsych-6.0.1/stimuli/vince_stimuli/' + stim_sel[randPos[0]] +'.png';
          imageset.image2='jsPsych-6.0.1/stimuli/vince_stimuli/' + stim_sel[randPos[1]] +'.png';
          imageset.image3='jsPsych-6.0.1/stimuli/vince_stimuli/' + stim_sel[randPos[2]] +'.png';
          imageset.image4='jsPsych-6.0.1/stimuli/vince_stimuli/' + stim_sel[randPos[3]] +'.png';
          console.log(imageset)
        }
      }
      var reward_imageset={
        image1: 'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_a[trialCounter] +'.png',
        image2:'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_b[trialCounter] +'.png',
        image3:'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_c[trialCounter] +'.png',
        image4:'jsPsych-6.0.1/stimuli/vince_stimuli/' + assoc_list_d[trialCounter] +'.png',

      }

      var reward_trial = {
        type: 'reward',
        stimulus: 'img/happy_face_1.jpg',
        choices: [37,39],
        prompt: '<p>Which image will you bet on? (Left or Right Arrow)</p>',
        response_ends_trial: true,
      }


      var decision_trial = {
        type: 'decision',
        trial_duration:4500,
        number_of_apertures:2,
        response_ends_trial:false,
        coherent_direction:[0,90],
        coherence:1.0,
        move_distance:3,
        aperture_width:300,
        aperture_height:300,
        aperture_center_x:[(window.innerWidth/4),(window.innerWidth*3/4)],
        aperture_center_y:[window.innerHeight/2,window.innerHeight/2],
        aperture_type:4,
        fixation_cross:false,
        border:true,
      }
      function repeat_array(reps,array){
      var arr= []
      for (var i=0; i < reps ;i++){
        arr.push(array);
      }
      return arr
    }

    function shuffle(a) {
        var j, x, i;
        var newArray
        newArray=a;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            newArray[i] = a[j];
            newArray[j] = x;

    }
    return newArray
    }//shuffle



///more modern perhaps
          var main_instructions_block = {
            type: "instructions",
            pages: ["In this portion of the experiment, you will view 4 categories of images presented on top of a series of moving dots."+
            ""
          ],
          show_clickable_nav:true,
          allow_keys:true,
          button_label_next: 'Continue',

}




       function makeAllTrialTypes(trialArray){
         var newArray=[];
         for (var i=0; i<trialArray.length; i++){
           for (var t=0; t<trial_types.length; t++){
             var tempTrial=Object.assign({},trialArray[i]);
             tempTrial.trial_type=trial_types[t];
             newArray.push(tempTrial);
           }
         }
       return newArray
       }

       function interleavePostTrialBlocks(trialArray){
         var newArray=[];
         for (var i=0;i<trialArray.length;i++){
           newArray.push(trialArray[i],response1,response2,response3,intensity_update)
         }
         return newArray
       }
       function insertMiddleBreak(trialArray,break_block){
         midIdx=Math.floor(trialArray.length/2);
         trialArray.splice(midIdx,0,break_block)
         return trialArray
       }




       var break_block={
         type: 'html-keyboard-response',
         stimulus: "Feel free to take a break for up to 60s.  Press any key to continue.  The experiment will resume automatically in 60s if no key is pressed.",
         choices: jsPsych.ALL_KEYS,
         trial_duration: 60000,
         response_ends_trial: true,


       }

       //var trialBones=[test_block_1,test_block_2,test_block_3,test_block_4]
      // var allTrialTypes=makeAllTrialTypes(trialBones)
       //var trialsArray=jsPsych.randomization.repeat(allTrialTypes,5)
       //var allTrials=interleavePostTrialBlocks(trialsArray);
       //var allTrials=insertMiddleBreak(allTrials,break_block);



    //  var main_test_procedure={
      //   timeline: allTrials,

       //}


       timeline=[]
       var association_test_procedure={
         timeline:[main_trial],
         timeline_variables:[{coherent_direction: '0'},{coherent_direction:'180'}],
         randomize_order: true,
         repetitions:10,
       }

       var reward_test_procedure={
         timeline:[reward_trial],
         repetitions:5
       }
       var decision_test_procedure={
         timeline:[decision_trial]
       }

       timeline.push({
         type: 'fullscreen',
         fullscreen_mode: true
       })
    //  timeline.push(calib_loop_timeline,iso_instructions_block,fixation_block,iso_test_procedure,iso_debrief_block)
      //timeline.push(main_instructions_block,fixation_block,initialize_staircases,main_test_procedure,break_block,main_test_procedure)
    //  timeline.push(association_test_procedure)
    //  timeline.push(reward_test_procedure)
      timeline.push(main_instructions_block,decision_test_procedure)
      jsPsych.init({
        timeline:timeline,
        on_finish: function(){
        //  jsPsych.data.get().localSave('csv','localizationPilot.csv'); //Save the data locally in a .csv file

          jsPsych.data.displayData();}
      })



      </script>
      </html>
